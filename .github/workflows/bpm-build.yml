name: BPM Build Pipeline

on:
  workflow_dispatch:
    inputs:
      app_to_build:
        description: 'Application(s) to build (comma-separated or ALL)'
        required: true
        default: 'ALL'
        type: string
      release:
        description: 'Release version'
        required: true
        default: 'grs'
        type: string
      branch_type:
        description: 'Branch type (develop, main, etc.)'
        required: true
        default: 'develop'
        type: string
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  RELEASE: ${{ github.event.inputs.release || 'grs' }}
  BRANCH_TYPE: ${{ github.event.inputs.branch_type || 'develop' }}
  APP_TO_BUILD: ${{ github.event.inputs.app_to_build || 'ALL' }}

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout build repository
        uses: actions/checkout@v4
        with:
          path: build-repo
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      
      - name: Set up Ant
        shell: pwsh
        run: |
          choco install ant -y
          refreshenv
      
      - name: Generate version number
        id: version
        shell: pwsh
        run: |
          $VERSION_NUM = Get-Date -Format "yyyyMMdd-HH:mm"
          "version_num=$VERSION_NUM" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Generated version: $VERSION_NUM"
      
      - name: Create version info file
        shell: pwsh
        run: |
          New-Item -Path "build-workspace\mliConf" -ItemType Directory -Force | Out-Null
          "GRS_BPM_${{ env.RELEASE }}_${{ env.BRANCH_TYPE }}_${{ steps.version.outputs.version_num }}" | Out-File -FilePath "build-workspace\mliConf\VersionInfo.txt" -NoNewline
      
      - name: Determine applications to build
        id: apps
        shell: pwsh
        run: |
          if ("${{ env.APP_TO_BUILD }}" -eq "ALL") {
            # Full list of all applications
            $APPS = "ActivatePolicySTPApp,ActivatePolicySTPproxy,agreement,agreementcompensation,agreementinvestments,agreementrules,agreementservices,assignPPSG,authorization,B2BAllianceSTPProxy,BulkContributionApp,BulkContributionSTPProxy,DecisionManagementproxy,emailnotification,employerPlanChangeSTPApp,employerPlanChangeSTPProxy,establishIndividual,establishMember,findadvisor,findadvisoragreement,findcustomer,findplangroup,fundDirection,funddiscretion,GroupPlanSetupSTPproxy,GroupPlanSetupSTPvApp,grsContributionsMediation,grsManageCustomerBrandingNContactInfoMediation,GRSSecurityMediation,GRSSecuritySSO,GRS_AccountDetailsMediationApp,GRS_AccountMediationApp,GRS_ManageCustomerContactInfoMediationApp,IndividualFlowSTPproxy,IndividualFlowSTPvApp,manageAffiliate,manageAgreementContributions,manageAgreementInvestmentPackage,ManageAgreementPayroll,ManageAwdCpoTracking,managebankinfo,manageBeneficiary,managecontract,manageCustomer,managecustomeraddress,ManageCustomerRelationship,managecustomertelephone,manageEApplication,manageEnrolment,manageEventTracking,managefinancialinstitution,ManageIndividual,managemember,managePayrollIntegration,managePlanGroup,managePlanTransfer,managePolicy,manageProfile,ManageServiceLog,ManageSponsor,managestatement,managesubmission,managetransaction,ManageUtilityMediationApp,MemberPlanChangesSTPApp,MemberPlanChangesSTPProxy,MemberShellEnrolmentSTPApp,newPlanSTPApp,newPlanSTPProxy,organizationstructure,PayrollIntegrationGateway,policyregistration,productcatalog,referencecatalog,ShellEnrolmentSTPproxy,verifyCustomer,viewAvailableInvestments"
          } else {
            $APPS = "${{ env.APP_TO_BUILD }}"
          }
          "apps=$APPS" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Applications to build: $APPS"
      
      - name: Clone required repositories
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $BRANCH_NAME = "${{ env.BRANCH_TYPE }}-${{ env.RELEASE }}"
          Write-Host "Branch name: $BRANCH_NAME"
          
          # Create workspace directory
          New-Item -Path "repos" -ItemType Directory -Force | Out-Null
          Set-Location repos
          
          # Parse the app list
          $APP_LIST = "${{ steps.apps.outputs.apps }}" -split ','
          
          # Keep track of already cloned repos to avoid duplicates
          $CLONED_REPOS = @{}
          
          # Process each application
          foreach ($APP in $APP_LIST) {
            $APP = $APP.Trim()
            $GIT_FILE = "..\build-repo\SonarGitFiles\GIT-BPM_$APP.txt"
            
            Write-Host "Processing application: $APP"
            Write-Host "Looking for git file: $GIT_FILE"
            
            if (Test-Path $GIT_FILE) {
              Write-Host "Found git file for $APP"
              
              # Read each git URL from the file
              $GIT_URLS = Get-Content $GIT_FILE | Where-Object { $_.Trim() -ne "" }
              
              foreach ($GIT_URL in $GIT_URLS) {
                # Extract repo name from URL
                $REPO_NAME = [System.IO.Path]::GetFileNameWithoutExtension($GIT_URL)
                
                # Skip if already cloned
                if ($CLONED_REPOS.ContainsKey($REPO_NAME)) {
                  Write-Host "  Repository $REPO_NAME already cloned, skipping..."
                  continue
                }
                
                Write-Host "  Cloning repository: $REPO_NAME from $GIT_URL"
                
                # Clone the repository with the specific branch
                git clone --branch $BRANCH_NAME --depth 1 $GIT_URL 2>&1 | Out-Null
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "  [OK] Successfully cloned $REPO_NAME (branch: $BRANCH_NAME)"
                  $CLONED_REPOS[$REPO_NAME] = $true
                } else {
                  Write-Host "  [WARN] Failed to clone $REPO_NAME with branch $BRANCH_NAME, trying default branch..."
                  git clone --depth 1 $GIT_URL 2>&1 | Out-Null
                  if ($LASTEXITCODE -eq 0) {
                    Write-Host "  [OK] Successfully cloned $REPO_NAME (default branch)"
                    $CLONED_REPOS[$REPO_NAME] = $true
                  } else {
                    Write-Host "  [ERROR] Failed to clone $REPO_NAME"
                  }
                }
              }
            } else {
              Write-Host "[WARN] Warning: Git file not found for $APP"
            }
          }
          
          Write-Host ""
          Write-Host "Summary of cloned repositories:"
          Get-ChildItem
        env:
          # Use GitHub token or setup SSH keys as needed
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Copy repositories to build workspace
        shell: pwsh
        run: |
          if (Test-Path "build-repo") { Copy-Item -Path "build-repo\*" -Destination "build-workspace\" -Recurse -Force -ErrorAction SilentlyContinue }
          if (Test-Path "repos") { Copy-Item -Path "repos\*" -Destination "build-workspace\" -Recurse -Force -ErrorAction SilentlyContinue }
      
      - name: Build applications
        shell: pwsh
        run: |
          Set-Location build-workspace
          
          # Branch name for builds
          $BRANCH_NAME = "${{ env.BRANCH_TYPE }}-${{ env.RELEASE }}"
          
          # Parse the app list
          $APP_LIST = "${{ steps.apps.outputs.apps }}" -split ','
          
          # Build each application
          foreach ($APP in $APP_LIST) {
            $APP = $APP.Trim()
            $PROP_FILE = "build_$APP.properties"
            $SRC_FILE = "GIT-BPM_$APP.txt"
            
            Write-Host ""
            Write-Host "========================================="
            Write-Host "Building application: $APP"
            Write-Host "Property file: $PROP_FILE"
            Write-Host "Source file: $SRC_FILE"
            Write-Host "========================================="
            
            if ((Test-Path "Properties\$PROP_FILE") -and (Test-Path "SonarGitFiles\$SRC_FILE")) {
              # Run Ant build
              ant -buildfile build-single.xml `
                -Dbuild.app="$PROP_FILE" `
                -Dgit.source.file="$SRC_FILE" `
                -Dgit.branch="$BRANCH_NAME"
              
              if ($LASTEXITCODE -ne 0) {
                Write-Host "[WARN] Build failed for $APP, continuing..."
                continue
              }
              Write-Host "[OK] Successfully built $APP"
            } else {
              Write-Host "[WARN] Skipping $APP - missing property or git file"
            }
          }
      
      - name: Create standalone JAR (GRS_Common.jar)
        shell: pwsh
        run: |
          Set-Location build-workspace
          
          $SOURCE_DIR = "target\zip\expanded_folder\GRS_Common.jar"
          $JAR_NAME = "GRS_Common.jar"
          $OUTPUT_DIR = "target\standalone_jars"
          
          if (Test-Path $SOURCE_DIR) {
            Write-Host "Creating enterprise-standard standalone GRS_Common.jar"
            
            New-Item -Path $OUTPUT_DIR -ItemType Directory -Force | Out-Null
            New-Item -Path "temp\jar_creation" -ItemType Directory -Force | Out-Null
            
            # Copy files excluding development artifacts
            $excludePatterns = @('*.java', '.factorypath', '.jazzignore', '.gitignore', '.project', '.classpath', '.git', '.svn', '.settings', 'target', 'bin')
            Get-ChildItem -Path $SOURCE_DIR -Recurse | Where-Object {
              $item = $_
              $shouldExclude = $false
              foreach ($pattern in $excludePatterns) {
                if ($item.Name -like $pattern -or $item.PSIsContainer -and $item.Name -in @('.git', '.svn', '.settings', 'target', 'bin')) {
                  $shouldExclude = $true
                  break
                }
              }
              -not $shouldExclude
            } | ForEach-Object {
              $dest = $_.FullName.Replace($SOURCE_DIR, "temp\jar_creation")
              $destDir = Split-Path $dest -Parent
              if (-not (Test-Path $destDir)) { New-Item -Path $destDir -ItemType Directory -Force | Out-Null }
              Copy-Item $_.FullName -Destination $dest -Force
            }
            
            # Copy version info
            if (Test-Path "mliConf\VersionInfo.txt") {
              New-Item -Path "temp\jar_creation\META-INF" -ItemType Directory -Force | Out-Null
              Copy-Item "mliConf\VersionInfo.txt" -Destination "temp\jar_creation\META-INF\" -Force
            }
            
            # Create JAR
            Set-Location temp\jar_creation
            jar -cf "..\..\$OUTPUT_DIR\$JAR_NAME" *
            Set-Location ../..
            
            Write-Host "[OK] Successfully created $JAR_NAME"
            Get-Item "$OUTPUT_DIR\$JAR_NAME" | Format-List Name, Length
          } else {
            Write-Host "[WARN] Source directory not found: $SOURCE_DIR"
          }
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bpm-build-artifacts-${{ steps.version.outputs.version_num }}
          path: |
            build-workspace\target\ear\**\*.ear
            build-workspace\target\standalone_jars\**\*.jar
          retention-days: 30
      
      - name: Categorize BPM cluster artifacts
        shell: pwsh
        run: |
          Set-Location build-workspace\target\ear
          
          # BPM cluster EAR files
          $BPM_CLUSTER_EARS = @(
            "GRS_ActivatePolicySTP_ModApp.ear",
            "GRS_B2BAllianceSTP_ProxyModApp.ear",
            "GRS_CeridianBulkContributionSTP_ProxyModApp.ear",
            "GRS_CeridianEmployerPlanChangesSTP_ModApp.ear",
            "GRS_CeridianMemberPlanChangesSTP_ModApp.ear",
            "GRS_CeridianNewPlanSTP_ModApp.ear",
            "GRS_GroupPlanSetupSTP_ProxyModApp.ear",
            "GRS_IndividualFlowSTP_ProxyModApp.ear",
            "GRS_MemberShellEnrolmentSTPApp.ear",
            "GRS_CeridianBulkContributionSTP_Mod_v1_0_1App.ear",
            "GRS_GroupPlanSetupSTP_Mod_v1_2_1App.ear",
            "GRS_IndividualFlowSTP_Mod_v1_0_3App.ear"
          )
          
          New-Item -Path "..\cluster_bpm" -ItemType Directory -Force | Out-Null
          New-Item -Path "..\cluster_svc" -ItemType Directory -Force | Out-Null
          
          # Move BPM cluster EARs
          foreach ($EAR in $BPM_CLUSTER_EARS) {
            if (Test-Path $EAR) {
              Write-Host "Moving $EAR to cluster_bpm\"
              Move-Item $EAR -Destination "..\cluster_bpm\" -Force
            }
          }
          
          # Move remaining EARs to cluster_svc
          Get-ChildItem -Filter "*.ear" | ForEach-Object {
            Write-Host "Moving $($_.Name) to cluster_svc\"
            Move-Item $_.FullName -Destination "..\cluster_svc\" -Force
          }
      
      - name: Upload BPM cluster artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bpm-cluster-artifacts-${{ steps.version.outputs.version_num }}
          path: build-workspace\target\cluster_bpm\**\*.ear
          retention-days: 30
        if: success()
      
      - name: Upload Service cluster artifacts
        uses: actions/upload-artifact@v4
        with:
          name: service-cluster-artifacts-${{ steps.version.outputs.version_num }}
          path: build-workspace\target\cluster_svc\**\*.ear
          retention-days: 30
        if: success()
      
      - name: Build Summary
        if: always()
        shell: pwsh
        run: |
          "## Build Summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Release**: ${{ env.RELEASE }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Branch Type**: ${{ env.BRANCH_TYPE }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Applications**: ${{ env.APP_TO_BUILD }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Version**: ${{ steps.version.outputs.version_num }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          if (Test-Path "build-workspace\target\ear") {
            "### Built Artifacts" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "``````" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            Get-ChildItem -Path "build-workspace\target" -Include @("*.ear", "*.jar") -Recurse | Select-Object -ExpandProperty FullName | Sort-Object | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            "``````" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }
