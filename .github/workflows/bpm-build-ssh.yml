name: BPM Remote Build

# Connects to remote Windows build server and executes build script with user inputs

on:
  workflow_dispatch:
    inputs:
      app_to_build:
        description: 'Application(s) to build (comma-separated or ALL)'
        required: true
        default: 'ALL'
        type: string
      release:
        description: 'Release version'
        required: true
        default: 'grs'
        type: string
      branch_type:
        description: 'Branch type (develop, main, etc.)'
        required: true
        default: 'develop'
        type: string

env:
  RELEASE: ${{ github.event.inputs.release || 'grs' }}
  BRANCH_TYPE: ${{ github.event.inputs.branch_type || 'develop' }}
  APP_TO_BUILD: ${{ github.event.inputs.app_to_build || 'ALL' }}

jobs:
  remote-build:
    runs-on: windows-latest
    timeout-minutes: 180
    
    steps:
      - name: Setup SSH key for remote server
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          New-Item -Path $sshDir -ItemType Directory -Force | Out-Null
          
          $sshKey = "${{ secrets.BUILD_SERVER_SSH_KEY }}"
          $sshKey | Out-File -FilePath "$sshDir\id_rsa" -NoNewline -Encoding ASCII
          
          # Set proper permissions (read-only for owner)
          $acl = Get-Acl "$sshDir\id_rsa"
          $acl.SetAccessRuleProtection($true, $false)
          $rule = New-Object System.Security.AccessControl.FileSystemAccessRule($env:USERNAME, "FullControl", "Allow")
          $acl.SetAccessRule($rule)
          Set-Acl "$sshDir\id_rsa" $acl
          
          # Add host to known_hosts
          ssh-keyscan -H ${{ secrets.BUILD_SERVER_HOST }} | Out-File -FilePath "$sshDir\known_hosts" -Append -Encoding ASCII
      
      - name: Connect to remote server and trigger build
        shell: pwsh
        run: |
          Write-Host "Connecting to remote build server..."
          Write-Host "Parameters:"
          Write-Host "  - Application: ${{ env.APP_TO_BUILD }}"
          Write-Host "  - Release: ${{ env.RELEASE }}"
          Write-Host "  - Branch Type: ${{ env.BRANCH_TYPE }}"
          Write-Host ""
          
          $command = "`$env:AppToBuild='${{ env.APP_TO_BUILD }}'; `$env:Release='${{ env.RELEASE }}'; `$env:BranchType='${{ env.BRANCH_TYPE }}'; cd ${{ secrets.BUILD_SCRIPT_PATH }}; .\jenkins_buildfile.ps1"
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.BUILD_SERVER_USER }}@${{ secrets.BUILD_SERVER_HOST }} "powershell -Command `"$command`""
      
      - name: Build Summary
        if: always()
        shell: pwsh
        run: |
          "## Remote Build Summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Release**: ${{ env.RELEASE }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Branch Type**: ${{ env.BRANCH_TYPE }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Applications**: ${{ env.APP_TO_BUILD }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Build Server**: ${{ secrets.BUILD_SERVER_HOST }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "Build executed on remote Windows server." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
